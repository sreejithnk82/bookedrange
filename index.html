<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courier Range Extractor (Filtered)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 40px; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 30px; }
        textarea { width: 100%; height: 180px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; box-sizing: border-box; background: #fafafa; }
        .btn-container { margin: 20px 0; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        button:hover { background-color: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #7f8c8d; text-transform: uppercase; font-size: 13px; }
        .prefix-badge { background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .status-msg { font-size: 0.9em; color: #7f8c8d; margin-top: 10px; }
        .list-area { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; word-break: break-all; margin-top: 20px; font-size: 13px; max-height: 400px; overflow-y: auto; }
        .batch-header { color: #e67e22; font-weight: bold; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>Smart Range Extractor</h2>
    <p>Filters out failed requests and groups successful consignment numbers into ranges.</p>
    
    <textarea id="inputText" placeholder="Paste your raw table data here..."></textarea>
    
    <div class="btn-container">
        <button onclick="processData()">Process Successful Only</button>
    </div>

    <div id="resultsArea" style="display:none;">
        <div class="status-msg" id="stats"></div>
        
        <h2>Range Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Consignment Range / Number</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>

        <h2>Individual List (Batches of 100)</h2>
        <div id="commaList" class="list-area"></div>
    </div>
</div>

<script>
    function processData() {
        const text = document.getElementById('inputText').value;
        const resultBody = document.getElementById('resultBody');
        const commaList = document.getElementById('commaList');
        const resultsArea = document.getElementById('resultsArea');
        const stats = document.getElementById('stats');
        
        const rows = text.split(/\n/);
        const groups = {};
        const allSuccessful = []; // Flat list for the comma output
        let totalFound = 0;
        let successfulFound = 0;

        rows.forEach(line => {
            const trackingMatch = line.match(/\b([RVD])(\d{4,})\b/);
            
            if (trackingMatch) {
                totalFound++;
                if (line.toUpperCase().includes("SUCCESS")) {
                    successfulFound++;
                    const prefix = trackingMatch[1];
                    const numPart = trackingMatch[2];
                    const fullString = prefix + numPart;
                    const num = parseInt(numPart, 10);
                    const originalLength = numPart.length;

                    if (!groups[prefix]) groups[prefix] = [];
                    // Check for duplicates before adding
                    if (!groups[prefix].some(item => item.num === num)) {
                        groups[prefix].push({ num: num, len: originalLength, full: fullString });
                    }
                }
            }
        });

        if (totalFound === 0) {
            alert("No valid consignment numbers found (R, V, or D).");
            return;
        }

        stats.innerText = `Total identified: ${totalFound} | Successful: ${successfulFound} | Failed/Removed: ${totalFound - successfulFound}`;

        // Process for Ranges and Flat List
        resultBody.innerHTML = '';
        const sortedNumbers = [];

        Object.keys(groups).sort().forEach(prefix => {
            let items = groups[prefix].sort((a, b) => a.num - b.num);
            
            let i = 0;
            while (i < items.length) {
                let start = i;
                sortedNumbers.push(items[i].full); // Add to flat list

                while (i + 1 < items.length && items[i + 1].num === items[i].num + 1) {
                    i++;
                    sortedNumbers.push(items[i].full); // Add to flat list
                }

                const row = document.createElement('tr');
                const rangeCell = document.createElement('td');
                const countCell = document.createElement('td');

                if (start === i) {
                    const val = items[start].num.toString().padStart(items[start].len, '0');
                    rangeCell.innerHTML = `<span class="prefix-badge">${prefix}</span>${val}`;
                    countCell.innerText = "1";
                } else {
                    const startVal = items[start].num.toString().padStart(items[start].len, '0');
                    const endVal = items[i].num.toString().padStart(items[i].len, '0');
                    rangeCell.innerHTML = `<span class="prefix-badge">${prefix}</span>${startVal} â€” <span class="prefix-badge">${prefix}</span>${endVal}`;
                    countCell.innerText = (i - start + 1);
                }

                resultBody.appendChild(row);
                row.appendChild(rangeCell);
                row.appendChild(countCell);
                i++;
            }
        });

        // 3. Generate Comma Separated List in batches of 100
        let commaHTML = "";
        for (let i = 0; i < sortedNumbers.length; i += 100) {
            const batch = sortedNumbers.slice(i, i + 100);
            const batchNum = Math.floor(i / 100) + 1;
            commaHTML += `<span class="batch-header">Batch ${batchNum} (${i + 1} - ${Math.min(i + 100, sortedNumbers.length)})</span>`;
            commaHTML += batch.join(",");
            commaHTML += "\n------------------------------------------------------------\n";
        }
        commaList.innerHTML = commaHTML;

        resultsArea.style.display = 'block';
    }
</script>

</body>
</html>
